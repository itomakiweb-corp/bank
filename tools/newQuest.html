<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>新規クエスト発行</title>
  <meta name="description" content="新規クエストを発行します。" />
  <meta name="viewport" content="initial-scale=1" />
</head>
<body>
<h1>新規クエスト発行</h1>
<form id="newQuest">
<ul>
  <li><label><input type="text" name="token" value="" size="72" placeholder="token" /></label></li>
  <li><label><input type="text" name="title" value="" size="72" placeholder="title (required)" /></label></li>
  <li><label><textarea name="body" cols="72" rows="4" placeholder="body">
- 
- 
- 
</textarea></label></li>
  <li><label><input type="checkbox" name="assignAll" value="ALL" />全員に割り当てる</label></li>
  <li><label><input type="radio" name="priority" value="MDU6TGFiZWwxNjE1ODU5Njg5" />-priority: 1</label></li>
  <li><label><input type="radio" name="priority" value="MDU6TGFiZWwxNjE1ODYwMTE1" checked="checked" />-priority: 3</label></li>
  <li><label><input type="radio" name="priority" value="MDU6TGFiZWwxNjE1ODYwNTc0" />-priority: 5</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYzMDQ3" />cost-pre: 0</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYzNDE5" />cost-pre: 1</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYzODc5" />cost-pre: 2</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODY0MDA4" checked="checked" />cost-pre: 3</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODY0MTc2" />cost-pre: 5</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYyMTE4" />cost-pre: ?</label></li>
  <li><label><input type="text" name="milestoneId" value="" size="72" placeholder="milestoneId" /></label></li>
  <li><label><input type="submit" name="submit" value="クエスト発行" /></label></li>
  <li><label><textarea name="result" cols="72" rows="12" placeholder="result (readonly)" readonly></textarea></label></li>
</ul>
</form>
<script>
const $newQuest = document.querySelector('#newQuest')
$newQuest.addEventListener('submit', (e) => {
  // ブラウザデフォルト挙動の画面遷移を停止（後にreturn falseが必要な模様）
  e.preventDefault()

  const $result = $newQuest.querySelector('textarea[name="result"]')
  $result.value = ''

  const url = 'https://api.github.com/graphql'

  const token = $newQuest.querySelector('input[name="token"]').value
  const headers = {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json; charset=UTF-8',
  }

  const query = `mutation($input: CreateIssueInput!) {
    createIssue(input: $input) {
      issue {
        id
        url
        title
      }
    }
  }`
  const input = {
    repositoryId: configs.GITHUB_REPOSITORY_ID,
    title: $newQuest.querySelector('input[name="title"]').value,
    body: $newQuest.querySelector('textarea[name="body"]').value,
    labelIds: [
      $newQuest.querySelector('input[name="priority"]:checked').value,
      $newQuest.querySelector('input[name="cost-pre"]:checked').value,
    ],
    projectIds: configs.GITHUB_TODO_PROJECT_IDS,
    milestoneId: $newQuest.querySelector('input[name="milestoneId"]').value,
  }
  if ($newQuest.querySelector('input[name="assignAll"]:checked')) {
    input.assigneeIds = configs.GITHUB_TODO_ASSIGNEE_IDS
  }
  const variables = {
    input,
  }
  const payload = {
    query,
    variables,
  }

  const options = {
    method: 'post',
    headers,
    body: JSON.stringify(payload),
  }

  fetch(url, options)
    .then(response => response.json())
    .then(data => {
      $result.value = JSON.stringify(data, null, 2)
      if (!data.errors) {
        $newQuest.querySelector('input[name="title"]').value = ''
        $newQuest.querySelector('textarea[name="body"]').value = ''
      }
    })
    .catch(e => {
      $result.value = e.message
      console.error(e)
    })

  // ブラウザデフォルト挙動の画面遷移を停止
  return false
})
const configs = {
  GITHUB_REPOSITORY_ID: 'MDEwOlJlcG9zaXRvcnkyMTQxODM2ODE=',
  GITHUB_TODO_ASSIGNEE_IDS: [
    'MDQ6VXNlcjQzMjU1ODgw', // adachi-swivel
    'MDQ6VXNlcjQzNDM1OTg1', // bac0907
    'MDQ6VXNlcjE2NTA1Mjcx', // itomakiweb
    'MDQ6VXNlcjQzMTE0NDQx', // kazucharo
    'MDQ6VXNlcjQ1MDA2Njgz', // tanukinoyu
    'MDQ6VXNlcjQ0MjUyMzIx', // undine411
  ],
  GITHUB_TODO_PROJECT_IDS: [
    'MDc6UHJvamVjdDMzNTEwODU=', // Quest
  ],
}
</script>
</body>
</html>
