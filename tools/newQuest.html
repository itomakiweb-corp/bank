<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>クエスト発行</title>
  <meta name="description" content="新規クエストを発行します。" />
  <meta name="viewport" content="initial-scale=1" />
</head>
<body>
<form id="newQuest">
<ul>
  <li><label><input type="text" name="token" value="" size="72" placeholder="token" /></label></li>
  <li><label><input type="text" name="title" value="" size="72" placeholder="title" /></label></li>
  <li><label><textarea name="body" cols="72" rows="12" placeholder="body"></textarea></label></li>
  <li><label><input type="radio" name="priority" value="MDU6TGFiZWwxNjE1ODU5Njg5" />-priority: 1</label></li>
  <li><label><input type="radio" name="priority" value="MDU6TGFiZWwxNjE1ODYwMTE1" />-priority: 3</label></li>
  <li><label><input type="radio" name="priority" value="MDU6TGFiZWwxNjE1ODYwNTc0" />-priority: 5</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYzMDQ3" />cost-pre: 0</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYzNDE5" />cost-pre: 1</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYzODc5" />cost-pre: 2</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODY0MDA4" />cost-pre: 3</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODY0MTc2" />cost-pre: 5</label></li>
  <li><label><input type="radio" name="cost-pre" value="MDU6TGFiZWwxNjE1ODYyMTE4" />cost-pre: ?</label></li>
  <li><label><input type="submit" name="submit" value="クエスト発行" /></label></li>
  <li><label><textarea name="result" cols="72" rows="12" placeholder="result" readonly></textarea></label></li>
</ul>
</form>
<script>
const $newQuest = document.querySelector('#newQuest')
$newQuest.addEventListener('submit', (e) => {
  // ブラウザデフォルト挙動の画面遷移を停止（後にreturn falseが必要な模様）
  e.preventDefault()

  const $result = $newQuest.querySelector('textarea[name="result"]')
  $result.value = ''

  const url = 'https://api.github.com/graphql'

  const token = $newQuest.querySelector('input[name="token"]').value
  const headers = {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json; charset=UTF-8',
  }

  const query = `mutation($input: CreateIssueInput!) {
    createIssue(input: $input) {
      issue {
        id
        url
        title
      }
    }
  }`
  let input
  try {
    input = {
      repositoryId: configs.GITHUB_REPOSITORY_ID,
      title: $newQuest.querySelector('input[name="title"]').value,
      body: $newQuest.querySelector('textarea[name="body"]').value,
      labelIds: [
        $newQuest.querySelector('input[name="priority"]:checked').value,
        $newQuest.querySelector('input[name="cost-pre"]:checked').value,
      ],
      projectIds: configs.GITHUB_TODO_PROJECT_IDS,
    }
  } catch (e) {
    $result.value = 'ラジオボタンを選択してください'
    console.error(e)

    return false
  }
  const variables = {
    input,
  }
  const payload = {
    query,
    variables,
  }

  const options = {
    method: 'post',
    headers,
    body: JSON.stringify(payload),
  }

  fetch(url, options)
    .then(response => response.json())
    .then(data => {
      $result.value = JSON.stringify(data, null, 2)
      if (!data.errors) {
        $newQuest.reset()
        $newQuest.querySelector('input[name="token"]').value = token
      }
    })
    .catch(e => {
      $result.value = e.message
      console.error(e)
    })

  // ブラウザデフォルト挙動の画面遷移を停止
  return false
})
const configs = {
  GITHUB_REPOSITORY_ID: 'MDEwOlJlcG9zaXRvcnkyMTQxODM2ODE=',
  GITHUB_TODO_PROJECT_IDS: [
    'MDc6UHJvamVjdDMzNTEwODU=', // Quest
  ],
}
</script>
</body>
</html>
